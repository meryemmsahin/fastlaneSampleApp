default_platform(:ios)

platform :ios do
  desc "Pull Request açıldığında unit testleri çalıştırır"
  lane :ci_tests do
  ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "60"
  ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "6"

  # Eğer yanlış dizindeysek, ana dizine geri dön
  correct_path = "/Users/meryem.sahin/Projects/fastlanesample"
  current_path = sh("pwd", print_command: false).strip

  if current_path != correct_path
    UI.important("⚠️ Fastlane yanlış dizinde çalışıyor! Doğru dizine geçiliyor... 🚀")
    Dir.chdir(correct_path)
  end

  # Mevcut dizini yazdır
  sh "pwd"
  sh "ls -la"
  sh "find . -name '*.xcodeproj'"

  # ✅ **Proje yolunu mutlak yola çeviriyoruz**
  project_path = Dir.glob("*.xcodeproj").first
  UI.user_error!("❌ Xcode project not found!") if project_path.nil?

  absolute_project_path = File.expand_path(project_path)
  puts "✅ Xcode project found at: #{absolute_project_path}"

  # Swift Package Manager bağımlılıklarını çöz
  sh "xcodebuild -resolvePackageDependencies -scheme fastlanesample -project #{absolute_project_path}"

  # ✅ **`scan` için mutlak yolu kullanıyoruz**
  scan(
    scheme: "fastlanesample",
    clean: true,
    project: absolute_project_path, # Mutlak yol
    destination: "platform=iOS Simulator,id=71D594E0-3E1E-4C31-AFB9-DFEE3E99586F"
  )
end

  desc "Develop branch'ine pushlandığında Firebase'e deploy eder"
  lane :deploy_to_firebase do
    build_app(
      scheme: "fastlanesample",
      export_method: "development"
    )
    
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"], # Tek tek e-posta adresleri
      groups: ENV["FIREBASE_GROUPS"],   # Eğer grup kullanıyorsan
      release_notes: "Yeni build develop branch'inden gönderildi!"
    )
  end

  desc "Main branch'ine pushlandığında TestFlight'a gönderir"
  lane :deploy_to_testflight do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],       # API Key ID
      issuer_id: ENV["APP_STORE_ISSUER_ID"], # Apple Issuer ID
      key_content: ENV["APP_STORE_API_KEY"], # Base64 kodlanmış API Key içeriği
      in_house: false
    )

    build_app(
      scheme: "fastlanesample",
      export_method: "app-store"
    )
    
    upload_to_testflight
  end
end
default_platform(:ios)

platform :ios do
  desc "Pull Request aÃ§Ä±ldÄ±ÄŸÄ±nda unit testleri Ã§alÄ±ÅŸtÄ±rÄ±r"
  lane :ci_tests do
  ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "60"
  ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "6"

  # EÄŸer yanlÄ±ÅŸ dizindeysek, ana dizine geri dÃ¶n
  correct_path = "/Users/meryem.sahin/Projects/fastlanesample"
  current_path = sh("pwd", print_command: false).strip

  if current_path != correct_path
    UI.important("âš ï¸ Fastlane yanlÄ±ÅŸ dizinde Ã§alÄ±ÅŸÄ±yor! DoÄŸru dizine geÃ§iliyor... ğŸš€")
    Dir.chdir(correct_path)
  end

  # Mevcut dizini yazdÄ±r
  sh "pwd"
  sh "ls -la"
  sh "find . -name '*.xcodeproj'"

  # âœ… **Proje yolunu mutlak yola Ã§eviriyoruz**
  project_path = Dir.glob("*.xcodeproj").first
  UI.user_error!("âŒ Xcode project not found!") if project_path.nil?

  absolute_project_path = File.expand_path(project_path)
  puts "âœ… Xcode project found at: #{absolute_project_path}"

  # Swift Package Manager baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± Ã§Ã¶z
  sh "xcodebuild -resolvePackageDependencies -scheme fastlanesample -project #{absolute_project_path}"

  # âœ… **`scan` iÃ§in mutlak yolu kullanÄ±yoruz**
  scan(
    scheme: "fastlanesample",
    clean: true,
    project: absolute_project_path, # Mutlak yol
    destination: "platform=iOS Simulator,id=71D594E0-3E1E-4C31-AFB9-DFEE3E99586F"
  )
end

  desc "Develop branch'ine pushlandÄ±ÄŸÄ±nda Firebase'e deploy eder"
  lane :deploy_to_firebase do
    build_app(
      scheme: "fastlanesample",
      export_method: "development"
    )
    
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"], # Tek tek e-posta adresleri
      groups: ENV["FIREBASE_GROUPS"],   # EÄŸer grup kullanÄ±yorsan
      release_notes: "Yeni build develop branch'inden gÃ¶nderildi!"
    )
  end

  desc "Main branch'ine pushlandÄ±ÄŸÄ±nda TestFlight'a gÃ¶nderir"
  lane :deploy_to_testflight do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],       # API Key ID
      issuer_id: ENV["APP_STORE_ISSUER_ID"], # Apple Issuer ID
      key_content: ENV["APP_STORE_API_KEY"], # Base64 kodlanmÄ±ÅŸ API Key iÃ§eriÄŸi
      in_house: false
    )

    build_app(
      scheme: "fastlanesample",
      export_method: "app-store"
    )
    
    upload_to_testflight
  end
end
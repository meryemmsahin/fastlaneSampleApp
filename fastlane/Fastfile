default_platform(:ios)

platform :ios do
  desc "Pull Request aÃ§Ä±ldÄ±ÄŸÄ±nda unit testleri Ã§alÄ±ÅŸtÄ±rÄ±r"
lane :ci_tests do
  ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "60"
  ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "6"

  # Fastlane'in Ã§alÄ±ÅŸtÄ±ÄŸÄ± ana dizini bul
  root_path = sh("git rev-parse --show-toplevel", print_command: false).strip
  Dir.chdir(root_path)

  # Mevcut dizini yazdÄ±r
  sh "pwd"
  sh "ls -la"
  sh "find . -name '*.xcodeproj'"

  # Proje yolunu bul
  project_path = Dir.glob("*.xcodeproj").first
  UI.user_error!("âŒ Xcode project not found!") if project_path.nil?

  puts "âœ… Xcode project found at: #{project_path}"

  # Swift Package Manager baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± Ã§Ã¶z
  sh "xcodebuild -resolvePackageDependencies -scheme fastlanesample -project #{project_path}"

  # âœ… Mevcut simÃ¼latÃ¶rÃ¼ dinamik olarak bul ve aÃ§
  available_simulators = sh("xcrun simctl list devices available", print_command: false)
  matched_simulator = available_simulators.match(/(iPhone [0-9]+|iPhone SE \([0-9]+\)) \((.*?)\) \(Shutdown\)/)

  if matched_simulator.nil?
    UI.user_error!("âŒ Uygun bir kapalÄ± simÃ¼latÃ¶r bulunamadÄ±!")
  end

  simulator_name = matched_simulator[1]
  simulator_udid = matched_simulator[2]

  puts "âœ… KullanÄ±lacak SimÃ¼latÃ¶r: #{simulator_name} (UDID: #{simulator_udid})"

  # SimÃ¼latÃ¶rÃ¼ baÅŸlat
  sh "xcrun simctl boot #{simulator_udid}"
  puts "ğŸš€ SimÃ¼latÃ¶r baÅŸlatÄ±ldÄ±: #{simulator_name}"

  # ğŸ“Œ Xcode'un simÃ¼latÃ¶rÃ¼ tam olarak tanÄ±masÄ±nÄ± bekleyelim
  puts "â³ SimÃ¼latÃ¶rÃ¼n tamamen aÃ§Ä±lmasÄ± iÃ§in bekleniyor..."
  sleep(20) # âœ… Bekleme sÃ¼resini artÄ±rdÄ±k

  # ğŸ”„ Xcode simÃ¼latÃ¶r cache sÄ±fÄ±rlanÄ±yor
  puts "ğŸ”„ Xcode simÃ¼latÃ¶r cache sÄ±fÄ±rlanÄ±yor..."

  # TÃ¼m aÃ§Ä±k simÃ¼latÃ¶rleri kapat (varsa)
  sh "xcrun simctl shutdown all || true"

  # CoreSimulator Service'i sÄ±fÄ±rla (hata yoksa devam et)
  sh "pgrep -x 'com.apple.CoreSimulator.CoreSimulatorService' && sudo killall -9 com.apple.CoreSimulator.CoreSimulatorService || true"

  # Simulator'u sÄ±fÄ±rla (yalnÄ±zca Ã§alÄ±ÅŸan bir iÅŸlem varsa)
  sh "pgrep -x 'Simulator' && sudo killall -9 Simulator || true"

  sleep(5) # Biraz bekleyelim

  # âœ… Xcode iÃ§in derived data yolunu deÄŸiÅŸtiriyoruz
  scan(
    scheme: "fastlanesample",
    clean: true,
    project: File.expand_path(project_path),
    derived_data_path: "./fastlane/derivedData", # CI iÃ§in uygun yol
    destination: "platform=iOS Simulator,id=#{simulator_udid}"
  )
end

  desc "Develop branch'ine pushlandÄ±ÄŸÄ±nda Firebase'e deploy eder"
  lane :deploy_to_firebase do
    build_app(
      scheme: "fastlanesample",
      export_method: "development"
    )
    
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"], # Tek tek e-posta adresleri
      groups: ENV["FIREBASE_GROUPS"],   # EÄŸer grup kullanÄ±yorsan
      release_notes: "Yeni build develop branch'inden gÃ¶nderildi!"
    )
  end

  desc "Main branch'ine pushlandÄ±ÄŸÄ±nda TestFlight'a gÃ¶nderir"
  lane :deploy_to_testflight do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],       # API Key ID
      issuer_id: ENV["APP_STORE_ISSUER_ID"], # Apple Issuer ID
      key_content: ENV["APP_STORE_API_KEY"], # Base64 kodlanmÄ±ÅŸ API Key iÃ§eriÄŸi
      in_house: false
    )

    build_app(
      scheme: "fastlanesample",
      export_method: "app-store"
    )
    
    upload_to_testflight
  end
end
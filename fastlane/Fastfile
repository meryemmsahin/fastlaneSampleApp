default_platform(:ios)

platform :ios do
  desc "Pull Request aÃ§Ä±ldÄ±ÄŸÄ±nda unit testleri Ã§alÄ±ÅŸtÄ±rÄ±r"
  lane :ci_tests do
    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "60"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "6"

    # Fastlane'in Ã§alÄ±ÅŸtÄ±ÄŸÄ± ana dizini bul
    root_path = sh("git rev-parse --show-toplevel", print_command: false).strip
    Dir.chdir(root_path)

    # Mevcut dizini yazdÄ±r
    sh "pwd"
    sh "ls -la"
    sh "find . -name '*.xcodeproj'"

    # Proje yolunu bul
    project_path = Dir.glob("*.xcodeproj").first
    UI.user_error!("âŒ Xcode project not found!") if project_path.nil?

    puts "âœ… Xcode project found at: #{project_path}"

    # Swift Package Manager baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± Ã§Ã¶z
    sh "xcodebuild -resolvePackageDependencies -scheme fastlanesample -project #{project_path}"

    # ğŸ“Œ KullanÄ±labilir en gÃ¼ncel iPhone simÃ¼latÃ¶rÃ¼nÃ¼ otomatik seÃ§
    simulators = `xcrun simctl list devices available | grep 'iPhone' | grep '(17' | tail -1`
    simulator_name = simulators.match(/(iPhone \d+ \w+)/)[1] rescue "iPhone 15"

    UI.important("ğŸ“± KullanÄ±lacak SimÃ¼latÃ¶r: #{simulator_name}")

    # ğŸ“Œ `scan` iÃ§in doÄŸru yolu belirtiyoruz
    scan(
      scheme: "fastlanesample",
      clean: true,
      project: File.expand_path(project_path), # ğŸ”´ Mutlak yol kullanÄ±yoruz
      destination: "platform=iOS Simulator,name=#{simulator_name}" # ğŸ”¥ Dinamik SimÃ¼latÃ¶r SeÃ§imi
    )
  end

  desc "Develop branch'ine pushlandÄ±ÄŸÄ±nda Firebase'e deploy eder"
  lane :deploy_to_firebase do
    build_app(
      scheme: "fastlanesample",
      export_method: "development"
    )
    
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"], # Tek tek e-posta adresleri
      groups: ENV["FIREBASE_GROUPS"],   # EÄŸer grup kullanÄ±yorsan
      release_notes: "Yeni build develop branch'inden gÃ¶nderildi!"
    )
  end

  desc "Main branch'ine pushlandÄ±ÄŸÄ±nda TestFlight'a gÃ¶nderir"
  lane :deploy_to_testflight do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],       # API Key ID
      issuer_id: ENV["APP_STORE_ISSUER_ID"], # Apple Issuer ID
      key_content: ENV["APP_STORE_API_KEY"], # Base64 kodlanmÄ±ÅŸ API Key iÃ§eriÄŸi
      in_house: false
    )

    build_app(
      scheme: "fastlanesample",
      export_method: "app-store"
    )
    
    upload_to_testflight
  end
end